# ポストモーテム：Random Labeler サービス障害と復旧

**日時:** 2025-12-27 ~ 2025-12-29
**対象:** `random-labeler`
**影響:** サービス利用不可 (502/404エラー)、および古いラベルの残留

## 1. タイムライン（経緯）

1.  **[12/25] 安定稼働**: コミット `1c001a3` 時点では単純な構成で稼働していた。
2.  **[12/26-27] 検証機でのブランチ検証と混入**:
    - 本番環境とは別にブランチを切り、検証機 (`random-labeler2`) にデプロイして Hono 導入と Scheduler の動作確認を行っていた。
    - しかし、検証機へのデプロイ手段が「デプロイ設定を手動で書き換える（変数を `_2` 付きにする等）」という原始的な方法であり、運用操作が複雑化していた。
    - **転機**: 検証機で「動いた（プロセスが立った）」と判断した後、その変更を `main` にマージし、本番機へデプロイしたコミットが `8eb2f02` である。ここで「検証機では露見しなかったポート不整合」が本番機に持ち込まれた。
3.  **[12/28] 障害の顕在化**: 本番環境で `502 Bad Gateway` を検知。
4.  **[12/29] 誤った修正と環境の混乱**:
    - 502の原因調査において、本来は検証機で試すべき修正（Hono設定変更など）を本番機で直接試行錯誤し、さらに混乱を招いた。
    - 「今どちらの環境に向けて作業しているか」が、ブランチやリポジトリで明確に分かれておらず、手元の変数の状態に依存していたため、操作ミスを誘発した。
5.  **解決**: `12/25` の構成（Hono導入前）へロールバックし、検証機と本番機を意識的に切り離して復旧させた。

## 2. 根本原因分析 (Root Causes)

今回は「技術的な選択ミス」と「それを防げなかったプロセスの不備」が複合して発生した。

1.  **技術選定の飛躍 (Architecture)**
    *   **判断ミス**: 「ラベルの即時反映にはWebsocketが必要だが、今の構成では無理だ」と早合点し、モダンなフレームワークである Hono を導入して解決しようとした。実際には既存ライブラリがWebsocket機能を持っていたため、不要な複雑さを招いただけだった。
    *   **結果**: Hono（外側）とLabeler（内側）が別々のポートでサーバーを起動する「二重起動」が発生し、通信不能に陥った。

2.  **検証プロセスの欠落 (Verification)**
    *   **行動ミス**: 「コンテナのプロセスが起動した」ことだけを確認し、ローカル環境で `curl` 等を使って実際にリクエストを投げ、応答を確認する（E2Eテスト）工程を省いた。
    *   **結果**: 「サーバーは起きているが、リクエストを受け付けない（404/Connection Refused）」という致命的な状態のまま本番デプロイを行ってしまった。

3.  **変更管理の甘さ (Process)**
    *   **運用ミス**: 「Hono導入（リファクタリング）」「新機能（Scheduler更新）」「バグ修正（Unfollow対応）」を、1つのコミット（`8eb2f02`）に混在させて投入した。
    *   **結果**: 障害発生時に「Hono導入だけを取り消す」という選択肢が取れず、泥沼の修正作業（Fix Forward）を強いられた。

4.  **環境分離の不備 (Environment Isolation)**
    *   **運用ミス**: 本番機 (`random-labeler`) と検証機 (`random-labeler2`) を同一リポジトリで管理し、デプロイ先の切り替えを「環境変数名の手動変更（_2をつける等）」に依存していた。
    *   **結果**: この「危うい手動運用」が、切羽詰まった状況での誤デプロイ（検証のつもりで本番へ、あるいはその逆）を招き、本番環境を破壊する直接の原因となった。

## 3. 再発防止策（対抗措置）

上記4つの根本原因に対し、それぞれ以下の対策を講じる。

1.  **対・技術選定ミス (Architecture)**
    *   **Read the Docs**: 新しい技術やライブラリを導入する際は、思い込みで実装するのではなく、必ず公式ドキュメントやソースコードの「Architecture / Server Model」の項を確認する。特に既存のサーバーライブラリをラップする場合は、「二重起動」のリスクがないか調査を必須とする。

2.  **対・検証不足 (Verification)**
    *   **Mandatory Local E2E**: デプロイ前のローカル動作確認において、「プロセス起動」だけでなく「主要エンドポイントへの `curl` による疎通確認（実データの取得）」を必須とする。かっこいい自動テストでなくてよい、泥臭くても必ず実機で叩く手順を徹底する。

3.  **対・変更管理の甘さ (Process)**
    *   **Stop & Confirm**: AIアシスタントは、タスクの区切り（特にファイル変更前）で必ず手を止め、ユーザーに変更内容と意図を説明し、許可を得てから進める。勝手に先走り、複数の変更を1つのコミットに混ぜることを禁止する。

4.  **対・環境分離の不備 (Environment Isolation)**
    *   **Isolation by Pipeline**: 検証環境 (`random-labeler2`) へのデプロイは、本番 (`main`) とは異なるブランチ (`develop` / `staging`) からのみ行うようCI/CDまたはリポジトリ構成を分離する。「変数名の手動書き換え」によるターゲット変更運用を廃止し、物理的・論理的に混ざらない構成を原則とする。
